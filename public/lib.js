// Generated by CoffeeScript 1.3.3
(function() {
  var $, root;

  root = typeof exports !== "undefined" && exports !== null ? exports : this;

  root.Picplum = root.Picplum || {};

  $ = jQuery;

  Picplum.api_base = 'http://local.dev:3000/api/1';

  Picplum.init = function(app_id, opts) {
    var options;
    this.app_id = app_id;
    if (opts == null) {
      opts = {};
    }
    options = {
      insert_btns: true,
      insert_count: true,
      img_class: '.photo',
      print_bar_class: '.print_bar',
      print_selected_btn_class: '.print_selected_btn',
      print_all_btn_class: '.print_all_btn',
      selected_count_class: '.selected_count',
      apply_styles: true,
      debug: false
    };
    Picplum.settings = $.extend(options, opts);
    Picplum.debug = Picplum.settings.debug;
    Picplum.selected_photos = {};
    console.log("PicplumJS Init(" + this.app_id + ")");
    Picplum.PickerUI.init();
    return true;
  };

  Picplum.Photo = {
    selected_count: function() {
      var key, size;
      size = 0;
      console.log(Picplum.selected_photos);
      for (key in Picplum.selected_photos) {
        if (Picplum.selected_photos.hasOwnProperty(key)) {
          size++;
        }
      }
      return size;
    },
    select: function(thumb_url, url) {
      var new_id;
      new_id = this.uniqueId();
      Picplum.selected_photos[new_id] = {
        thumb_url: thumb_url,
        url: url
      };
      console.log('Photo selected: ' + new_id);
      return new_id;
    },
    deselect: function(id) {
      delete Picplum.selected_photos[id];
      console.log('Photo de-selected: ' + id);
      return id;
    },
    idCounter: 0,
    uniqueId: function(prefix) {
      var id;
      if (prefix == null) {
        prefix = 'c';
      }
      id = Picplum.Photo.idCounter++;
      return prefix + id;
    }
  };

  Picplum.Page = {
    create: function() {
      var req;
      req = $.ajax({
        type: "POST",
        url: Picplum.api_base + '/pages',
        dataType: "json",
        xhrFields: {
          withCredentials: true
        },
        data: {
          app_id: Picplum.app_id,
          images: Picplum.selected_photos,
          ref_url: window.location.href
        }
      });
      return req.done(function(data) {
        this.url = data.url;
        return this.open();
      });
    },
    open: function() {}
  };

  Picplum.PickerUI = {
    init: function() {
      console.log('Picker UI Init');
      this.print_bar();
      this.photos_grid();
      return this.bind_btns();
    },
    print_bar: function() {
      var el;
      el = $(Picplum.settings.print_bar_class);
      return el.html("<button class='btn " + (Picplum.settings.print_all_btn_class.replace('.', '')) + "' type='button'>Print All Photos</button>\n<button style=\"display: none;\" class='btn " + (Picplum.settings.print_selected_btn_class.replace('.', '')) + "' type='button'>Print Selected</button>\n<span style=\"display: none;\" class='" + (Picplum.settings.selected_count_class.replace('.', '')) + "'></span>");
    },
    photos_grid: function() {
      var el, self;
      self = this;
      console.log('Picker UI Init: Photos Grid');
      el = $(Picplum.settings.img_class);
      return el.on('click', function() {
        self.select(this);
        return self.selected_ui();
      });
    },
    bind_btns: function() {
      var _this = this;
      $(Picplum.settings.print_all_btn_class).on('click', function() {
        _this.select_all();
        return Picplum.Page.create();
      });
      return $(Picplum.settings.print_selected_btn_class).on('click', function() {
        return Picplum.Page.create();
      });
    },
    selected_ui: function() {
      var count, el;
      el = $(Picplum.settings.selected_count_class);
      count = Picplum.Photo.selected_count();
      if (count > 0) {
        el.html("<b>" + count + "</b> photos selected for print");
        el.show();
        return $(Picplum.settings.print_selected_btn_class).show();
      } else {
        el.hide();
        return $(Picplum.settings.print_selected_btn_class).hide();
      }
    },
    select: function(img) {
      var el, puid, selected;
      el = $(img);
      selected = el.data('puid');
      if (selected) {
        Picplum.Photo.deselect(selected);
        el.removeData('puid');
        return el.css({
          border: 0,
          margin: 0
        });
      } else {
        puid = Picplum.Photo.select(el.attr('src'), el.data('highres'));
        el.data('puid', puid);
        return el.css({
          'box-sizing': 'content-box',
          border: '4px solid black',
          margin: '-4px 0 0 -4px'
        });
      }
    },
    select_all: function() {
      var self;
      self = this;
      return $(Picplum.settings.img_class).each(function() {
        return self.select(this);
      });
    }
  };

}).call(this);
