// Generated by CoffeeScript 1.3.3
(function() {
  var $, root;

  root = typeof exports !== "undefined" && exports !== null ? exports : this;

  root.Picplum = root.Picplum || {};

  $ = jQuery;

  Picplum.api_base = 'http://local.dev:3000/api/1';

  Picplum.init = function(app_id, opts) {
    var options;
    this.app_id = app_id;
    if (opts == null) {
      opts = {};
    }
    options = {
      insert_btns: true,
      insert_count: true,
      img_class: '.photo',
      img_selected_class: 'selected_print',
      print_bar_class: '.print_bar',
      print_selected_btn_class: '.print_selected_btn',
      print_all_btn_class: '.print_all_btn',
      selected_count_class: '.selected_count',
      apply_styles: true,
      debug: false
    };
    Picplum.settings = $.extend(options, opts);
    Picplum.debug = Picplum.settings.debug;
    Picplum.selected_photos = {};
    if (Picplum.debug) {
      console.log("PicplumJS Init(" + this.app_id + ")");
    }
    Picplum.PickerUI.init();
    return true;
  };

  Picplum.Photo = {
    selected_count: function() {
      var key, size;
      size = 0;
      if (Picplum.debug) {
        console.log(Picplum.selected_photos);
      }
      for (key in Picplum.selected_photos) {
        if (Picplum.selected_photos.hasOwnProperty(key)) {
          size++;
        }
      }
      return size;
    },
    select: function(thumb_url, url) {
      var new_id;
      new_id = this.uniqueId();
      Picplum.selected_photos[new_id] = {
        thumb_url: thumb_url,
        url: url
      };
      if (Picplum.debug) {
        console.log('Photo selected: ' + new_id);
      }
      return new_id;
    },
    deselect: function(id) {
      delete Picplum.selected_photos[id];
      if (Picplum.debug) {
        console.log('Photo de-selected: ' + id);
      }
      return id;
    },
    idCounter: 0,
    uniqueId: function(prefix) {
      var id;
      if (prefix == null) {
        prefix = 'c';
      }
      id = Picplum.Photo.idCounter++;
      return prefix + id;
    }
  };

  Picplum.Page = {
    create: function() {
      Picplum.PickerUI.status('Creating Print Page');
      return this.send_data();
    },
    send_data: function() {
      var req,
        _this = this;
      return req = $.ajax({
        type: "POST",
        url: Picplum.api_base + '/pages',
        dataType: "json",
        xhrFields: {
          withCredentials: true
        },
        data: {
          app_id: Picplum.app_id,
          images: Picplum.selected_photos,
          ref_url: window.location.href
        },
        error: function() {
          return Picplum.PickerUI.status('', false);
        },
        success: function(data) {
          var url;
          Picplum.PickerUI.status('', false);
          console.info("Images Created");
          url = data.url;
          return _this.open(url);
        }
      });
    },
    open: function(url) {
      if (url == null) {
        url = '';
      }
      $('.open_picplum').attr({
        target: "_blank",
        title: "Print selected photos via Picplum.com"
      });
      $(".open_picplum").trigger('click');
      return window.location = url;
    }
  };

  Picplum.PickerUI = {
    init: function() {
      if (Picplum.debug) {
        console.log('Picker UI Init');
      }
      this.print_bar();
      this.photos_grid();
      return this.bind_btns();
    },
    print_bar: function() {
      var el;
      el = $(Picplum.settings.print_bar_class);
      return el.html("<button class='btn " + (Picplum.settings.print_all_btn_class.replace('.', '')) + "' type='button'>Print All Photos</button>\n<button style=\"display: none;\" class='btn " + (Picplum.settings.print_selected_btn_class.replace('.', '')) + "' type='button'>Print Selected</button>\n<span style=\"display: none;\" class='" + (Picplum.settings.selected_count_class.replace('.', '')) + "'></span>\n<a href='http://local.dev:3000' class='btn open_picplum' style=\"display: none\">Open Picplum</a>\n<div class=\"picplum_status\">This is the current status</div>");
    },
    photos_grid: function() {
      var el, self;
      self = this;
      if (Picplum.debug) {
        console.log('Picker UI Init: Photos Grid');
      }
      el = $(Picplum.settings.img_class);
      return el.on('click', function() {
        self.select(this);
        return self.selected_ui();
      });
    },
    bind_btns: function() {
      var _this = this;
      $(Picplum.settings.print_all_btn_class).on('click', function() {
        _this.select_all();
        return Picplum.Page.create();
      });
      $(Picplum.settings.print_selected_btn_class).on('click', function() {
        return Picplum.Page.create();
      });
      return $('.open_picplum').click(function() {
        window.open($(this).attr('href'));
        if (Picplum.debug) {
          return console.log('opne link');
        }
      });
    },
    selected_ui: function() {
      var count, el;
      el = $(Picplum.settings.selected_count_class);
      count = Picplum.Photo.selected_count();
      if (count > 0) {
        el.html("<b>" + count + "</b> photos selected for print");
        el.show();
        return $(Picplum.settings.print_selected_btn_class).show();
      } else {
        el.hide();
        return $(Picplum.settings.print_selected_btn_class).hide();
      }
    },
    select: function(img) {
      var el, puid, selected;
      el = $(img);
      selected = el.data('puid');
      if (selected) {
        Picplum.Photo.deselect(selected);
        return el.removeData('puid').removeClass(Picplum.settings.img_selected_class);
      } else {
        puid = Picplum.Photo.select(el.attr('src'), el.data('highres'));
        return el.data('puid', puid).addClass(Picplum.settings.img_selected_class);
      }
    },
    select_all: function() {
      var self;
      self = this;
      return $(Picplum.settings.img_class).each(function() {
        return self.select(this);
      });
    },
    status: function(msg, show) {
      if (msg == null) {
        msg = '';
      }
      if (show == null) {
        show = true;
      }
      return $(Picplum.settings.print_bar_class + ' .picplum_status').toggle(show).html(msg);
    }
  };

}).call(this);
